# Azure RNE606526S && Dialog DA14580 SoC - Buffer overflow attack

Attacking tool: Nordic nRF52840 Dongle 

Attacking target: Azure pacemaker RNE606526S

Sniffering tool: Adafruit Bluefruit LE Friend 

Analysis tool: Wireshark

**All the .pcapng files can be viewed directly using Wireshark**


## File Description

- The file 'RNE606526S Advertising interval Time Recordings' stores the time information of the advertising intervals of the pacemaker, under different circumstances. From the recordings we could see the performance difference when the buffer overflow attack is applied.

- The file 'DA14580_exploit_att_crash' stores the buffer overflow attack code (only the core part) written in Python.

- The zip file 'SDK 5.0.4.zip' is the latest SDK version of Dialog DA14580 SoC. It's also the version which is vulnerable to the buffer overflow attack.


## How to Apply Buffer Overflow Attack on Dialog DA14580 SoC

According to the SweynTooth tool (https://asset-group.github.io/disclosures/sweyntooth/), a buffer overflow attack could be applied on the Dialog DA14580 SoC by sending a malformed BLE data packet (a kind of packet sent in BLE data channel) to it. According to their work, they have proved their buffer overflow attack could crash the original Dialog SoC whose SDK version is 5.0.4 (latest), but they haven't tested it on Medtronic Azure bluetooth pacemakers which use the same underlying SoC.

After lots of tests, we found that several different buffer overflow attacks could be applied on both Dialog DA14580 development board (running a simple BLE slave example in SDK 5.0.4) and the Medtronic Azure pacemaker. For the former one, it will make the board crash and not able to be found by other Bluetooth devices unless it's manually reprogramed (Note the fireware is in SYSRAM rather than OTP). For the pacemaker, it will cause a 3-4s delay of starting the next advertising interval. The corresponding recording and analysis will be provided in the next section.

According to the author of the SweynTooth tool, they only published one kind of buffer overflow attack on Dialog DA14580 SoC, which is sending a malformed packet with an incorrect Link Layer Length (LL Len). However, we also found that a malformed packet with an incorrect Logical link control and adaptation protocol Length (L2CAP Len) or incorrect opcode of the Attribute layer PDU will cause the same attack as well.

The followings are 3 different types of buffer overflow attacks && examples of malformed BLE packets which could cause the attack. 'AA' means Access Address; 'LL' means Link Layer; 'L2CAP' means Logical link control and adaptation protocol. The source code (core part) has been uploaded as 'DA14580_exploit_att_crash.py'.

- Packet type: AA + LL Header + ***incorrect LL Len*** + L2CAP Len + L2CAP ChanId + Payload + CRC (Provided by SwyenTooth authors)

The part 'LL Len' is supposed to be the total length/number of bytes of the following 'L2CAP Len', 'L2CAP ChanId' and Payload parts. If LL len is smaller than the actual total length, there'll be truncated parts which will be out of the reception buffer. In this way a buffer overflow occurs. 

For example, in line 147 of the source code, the LL Len of the packet should be 0x07 instead of 0x05.

- Packet type: AA + LL Header + LL Len + ***incorrect L2CAP Len*** + L2CAP ChanId + Payload + CRC

The part 'L2CAP Len' should be the length of the Payload part. If it's smaller than the excepted length, it'll cause a reception buffer overflow as well.

For example, in line 145 of the source code, the L2CAP len should be 0x0003 (0x0300 is little endian), instead of 0x0000.

- Packet type: AA + LL Header + LL Len + L2CAP Len + L2CAP ChanId + ***Payload with an incorrect opcode*** + CRC

If the opcode of the Payload (Attribute PDU) can't be recognised by the receiver, it'll cause a crash on the Dialog DA14580 SoC. However, this shouldn't be considered as a buffer overflow because technically it doesn't cause an 'overflow' outside the reception buffer. However, sending this kind of packet does crash the Dialog board/cause a 3-4s delay at the Azure pacemaker. 

For example, in line 146 of the source code, the opcode 0x10 can't be recognised, even though the LL Len and L2CAP Len are correct.



## Where the Buffer Overflow is Reflected

### On Dialog DA14580 SoC

To test the influence of the buffer overflow attack, a BLE slave sample from Dialog DA14580 SDK 5.0.4 (latest) is run on the board. This sample makes the board keep sending advertisment packets and could generate a connection with any master devices who send a Connect_REQ to it. The master device could then read its manufacture info, etc. To test the effects of sending a malformed packet to the board, we not only tried to send the three different malformed packets mentioned above, but also sent one normal packet as the control group. The malformed and normal packets are sent using the attack board Nordic nRF52840 Dongle. Most of the codes come from the SweynTooth tool. The Adafruit Bluefruit LE Friend sniffer is used to monitor the whole process.


1. **Send malformed packet**

After connecting with the Dialog board, our attack board sends three malformed packets to it (to assure that the packet is received). When the packet contains an incorrect LL Len/L2CAP Len, the Dialog board will reply an Empty PDU as an ACK when receiving the first malformed packet, however, have no more reactions when receiving the rest of the packets. If the malformed packet contains an incorrect opcode, it's quite wired that no relevant procedures could be captured by the sniffer (The connection ends immediately but we can't see the slave receive anything). For all situations, the Dialog board is crashed at last, and still keeps dead even if the connection ends. The board could come back to life only if we reprogram it.

2. **Send normal packet**

To ensure that the malformed packets do crash the device, we send normal packets to see how the Dialog board reacts. For each normal packet sent, the Dialog board will reply an Empty PDU as ACK. After replying to the last normal packet, the Dialog board ends the connection and keeps sending advertisment packets in advertising channel. This could prove that the malformed packets could cause a crash on Dialog DA14580 SoC.

### On Azure pacemaker

The same tests are done for the pacemaker - three different malformed packets plus one normal packet are sent during the pacemaker's advertising interval. All the capturing results (advertising interval time in each case) are sorted out in the file 'RNE606526S Advertising interval Time Recordings.xlsx'. In this file, the exact time (in format hour:minute:second:millisecond) of the start/end of each advertising interval (13 consecutive intervals are recorded in total) && the time interval between two successive advertising intervals are recorded. It's worth noting that the advertising interval starts every three minutes when no interferences applied on it.

1. **Send malformed packet**

The reactions are exactly the same as the counterparts on Dialog DA14580 SoC, according to the capturing results of the sniffer. The difference is that the malformed packets crash the Dialog development board, but didn't do the same on the pacemaker. Instead, it causes a 3-4s delay on the next advertising interval. At the same time, we received the message from the hospital that the Azure pacemaker does have a restart mechanism. The effects could be seen in the file 'RNE606526S Advertising interval Time Recordings.xlsx'. 

2. **Send normal packet**

The pacamaker reacts the same as the Dialog board - replys one Empty PDU each time receving one normal packet. Different from sending a malformed packet, sending a normal packet won't cause any delays on the next advertising interval. The pacemaker behaves exactly the same as the situation when no interferences are applied on it. The effects could be seen in the file 'RNE606526S Advertising interval Time Recordings.xlsx'.

## Future Work

Try the Debugging mode on the Dialog DA14580 SoC. Try to find where the crash is caused.

Figure out if RCE could be done on it.
